<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>D3: Vertical axis added</title>
	<script type="application/javascript" src="d3.v3.js"></script>
	<script type="application/javascript" src="http://d3js.org/d3.v3.js"></script>
	<script type="application/javascript" src="21.js"></script>
	<style type="text/css">

		.axis path,
		.axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}

		.axis text {
			font-family: sans-serif;
			font-size: 11px;
		}
		#drag-me {
			width: 25%;
			height: 100%;
			margin: 10%;

			background-color: #29e;
			color: white;

			border-radius: 0.75em;
			padding: 4%;

			-webkit-transform: translate(0px, 0px);
			transform: translate(0px, 0px);
		}

		#drag-me::before {
			content: "#" attr(id);
			font-weight: bold;
		}
	</style>
</head>
<body>

<form id="mark">
	<p><b>Отметки:</b><br>
		<input type="text">

</form>
<form name="upload">
	<input type="file" name="file1">
	<input type="submit" value="Загрузить">
</form>


<button onclick="addMark()">Добавить отметку</button>
<button onclick="fasten(this.name)" name="descart">Зафиксировать систему координат</button>
<button onclick="fasten(this.name)" name="graph">Зафиксировать график</button>


<script type="text/javascript">
	var widthSVGdescart = document.body.clientWidth;
	var heightSVGdescart = screen.height * 0.75;
	var centrHSVGdescart = screen.height * 0.75 / 2;
	var centrWSVGdescart = document.body.clientWidth / 2;
	var fastenFlag = {
		"graph": true,
		"descart": true
	};
	var graph;
var countMarkX = 0;
	var marks = {};
	//Create SVG element
	var svg = d3.select("body")
			.append("svg")
			.attr("width", widthSVGdescart)
			.attr("height", heightSVGdescart);

	var descart = svg.append("g")
			.attr("id", "descart")
			.classed("descart", true);


	descart.append("line")
			.attr("id", "axisY")
			.attr("x1", widthSVGdescart / 2)
			.attr("y1", heightSVGdescart * -10)
			.attr("x2", widthSVGdescart / 2)
			.attr("y2", heightSVGdescart * 10)
			.style({
				"stroke": "red",
				"stroke-width": 1
			});

	descart.append("line")
			.attr("x1", widthSVGdescart / 2)
			.attr("y1", heightSVGdescart * -10)
			.attr("x2", widthSVGdescart / 2)
			.attr("y2", heightSVGdescart * 10)
			.style({
				"stroke": "red",
				"opacity": 0,
				"stroke-width": 30
			});

	descart.append("line")
			.attr("id", "axisX")
			.attr("x1", widthSVGdescart * -10)
			.attr("y1", heightSVGdescart / 2)
			.attr("x2", widthSVGdescart * 10)
			.attr("y2", heightSVGdescart / 2)
			.style({
				"stroke": "red",
				"stroke-width": 1
			});

	descart.append("line")
			.attr("x1", widthSVGdescart * -10)
			.attr("y1", heightSVGdescart / 2)
			.attr("x2", widthSVGdescart * 10)
			.attr("y2", heightSVGdescart / 2)
			.style({
				"stroke": "red",
				"opacity": 0,
				"stroke-width": 30
			});

	descart.append("circle")
			.attr("id", "zero")
			.attr("cx", centrWSVGdescart)
			.attr("cy", centrHSVGdescart)
			.attr("r", 2)
			.style({
				"stroke": "black",
				"stroke-width": 2
			});

	var marksGroup = descart.append("g")
			.attr("id", "marksGroup");



	function fasten (name) {
		if(name === "descart")descart.classed("descart", fastenFlag[name] = !fastenFlag[name]);
		if(name === "graph")graph.classed("descart", fastenFlag[name] = !fastenFlag[name]);
	}


	function addMark() {
		var name = "mark" + countMarkX++;
		var mark = marks[name] = {};
		mark.input = d3.select("#mark")
				.append("input")
				.attr("name", name)
				.attr("type", "text");

		mark.g = descart.append("g")
				.classed("point", true);

		mark.g.append("line")
				.attr("x1", centrWSVGdescart + 100)
				.attr("y1", centrHSVGdescart - 50)
				.attr("x2", centrWSVGdescart + 100)
				.attr("y2", centrHSVGdescart + 50)
				.style({
					"stroke": "red",
					"stroke-width": 1
				});
		mark.g.append("line")
				.attr("x1", centrWSVGdescart + 100)
				.attr("y1", centrHSVGdescart - 50)
				.attr("x2", centrWSVGdescart + 100)
				.attr("y2", centrHSVGdescart + 50)
				.style({
					"stroke": "red",
					"opacity": 0,
					"stroke-width": 30
				});
	}


	interact('.descart')
			.draggable({
				inertia: true,
				restrict: {
					elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
				},
				onmove: function (event) {
					var target = event.target,
							x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
							y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
					// translate the element
					target.style.webkitTransform =
							target.style.transform =
									'translate(' + x + 'px, ' + y + 'px)';

					// update the posiion attributes
					target.setAttribute('data-x', x);
					target.setAttribute('data-y', y);
				},
				// call this function on every dragend event
				onend: function (event) {
					var textEl = event.target.querySelector('p');

					textEl && (textEl.textContent =
							'moved a distance of '
							+ (Math.sqrt(event.dx * event.dx +
							event.dy * event.dy)|0) + 'px');
				}
			});

	interact('.point')
			.draggable({
				// enable inertial throwing
				inertia: true,
				// keep the element within the area of it's parent
				restrict: {
					elementRect: { left: 0, right: 0, top: 1, bottom: 1 }
				},

				// call this function on every dragmove event
				onmove: function (event) {
					var target = event.target,
					// keep the dragged position in the data-x/data-y attributes
							x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
							y = 0;
					// translate the element
					target.style.webkitTransform =
							target.style.transform =
									'translate(' + x + 'px, ' + y + 'px)';

					// update the posiion attributes
					target.setAttribute('data-x', x);
					target.setAttribute('data-y', y);
				},
				// call this function on every dragend event
				onend: function (event) {
					var textEl = event.target.querySelector('p');
					textEl && (textEl.textContent =
							'moved a distance of '
							+ (Math.sqrt(event.dx * event.dx +
							event.dy * event.dy)|0) + 'px');
				}

			});



	var form = document.forms.upload;
	form.onsubmit = function() {
		var file = this.elements.file1.files[0];
		alert(this.elements.file1.files[0]);
		if (file) upload(file, onSuccess, onError, onProgress);
		return false;
	}

	function upload(file, onSuccess, onError, onProgress) {

		console.log(file);
		return false;
		var xhr = new XMLHttpRequest();

		xhr.onload = xhr.onerror = function() {
			if(this.status != 200 || this.responseText != 'OK') {
				onError(this);
				return;
			}
			onSuccess();
		};


		xhr.upload.onprogress = function(event) {
			onProgress(event.loaded, event.total);
		}


		xhr.open("POST", "upload.php", true);
		xhr.send(file);

	}



</script>
<script src="fileAPI.js"></script>

<div>
	<!-- "js-fileapi-wrapper" -- обязательный class -->
	<div class="js-fileapi-wrapper upload-btn" id="choose">
		<div class="upload-btn__txt">Choose files</div>
		<input name="files" type="file" multiple />
	</div>
	<div id="images"><!-- предпросмотр --></div>
</div>

<!--<script>window.FileAPI = { staticPath: '/js/FileAPI/dist/' };</script>-->
<!--<script src="/js/FileAPI/dist/FileAPI.min.js"></script>-->
<script>
	FileAPI.event.on(choose, 'change', function (evt){
		var files = FileAPI.getFiles(evt); // Retrieve file list

		FileAPI.filterFiles(files, function (file, info/**Object*/){
			if( /^image/.test(file.type) ){
				return  info.width >= 320 && info.height >= 240;
			}
			return  false;
		}, function (files/**Array*/, rejected/**Array*/){
			if( files.length ){
				// Создаем предпросмотр 100x100
				console.log(files);
				FileAPI.each(files, function (file){
					FileAPI.Image(file).preview(700).get(function (err, img){
						console.log(img);
						images.appendChild(img);
					});
				});

				graph = svg.insert("image", 'g#descart')
						.classed("descart", true)
						.attr("xlink:href", files[0].name)
						.attr("x", 0)
						.attr("y", 0)
						.attr("height", 483)
						.attr("width", 736);



				// Загружаем файлы
			}
		});
	});
</script>



<svg id="mySVG" width="1000" height="2000" >
	<image xlink:href="1418379167_proizvoditelnost-nasosa-kotla-baksi.-obrezka.jpg" x="0" y="0" height="483px" width="736px"/>
	<g  id="drag-me" class="draggable">
		<line x1="100" y1="-1000" x2="100" y2="2000" style="stroke:rgb(255,0,0);stroke-width:2" />
		<g class="point">
			<line x1="150" y1="150" x2="150" y2="250" style="stroke:rgb(27,7,100);stroke-width:2" />
		</g>
		<line x1="-1000" y1="200" x2="1000" y2="200" style="stroke:rgb(255,0,0);stroke-width:2" />
	</g>

	<g class="draggable">
		<path d="M 20 70 L 140 70 M 170 70 L 280 70" id="svg_2" stroke-linecap="null" stroke-linejoin="null" stroke-width="5" stroke="#000000" fill="none"/>
	</g>

	<svg viewBox="0 100 800 800">
		<rect  id="maroonRect"  x="200" y="200" width="160" height="60" fill="maroon" stroke="black" stroke-width="2"  />
	</svg>
	<g id="myG" >
		<rect id="blueRect"  x="220" y="250" width="60" height="60" fill="blue" stroke="black" stroke-width="2"  />
	</g>
	<circle id='blackCircle' r=10 fill=black />
</svg>

</body>
</html>